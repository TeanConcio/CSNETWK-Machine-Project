import java.net.*;
import java.io.*;

public class Server {
    public static void main(String[] args) {
        if (args.length != 1) {
            System.out.println("Usage: java Server <port_number>");
            return;
        }

        int nPort = Integer.parseInt(args[0]);
        ServerSocket serverSocket;

        try {
            serverSocket = new ServerSocket(nPort);

            System.out.println("Server: Listening on port " + nPort + "...");

            while (true) {
                // Accept client and initialize input and output streams
                Socket clientEndpoint = serverSocket.accept();
                System.out.println("Server: New client connected: " + clientEndpoint.getRemoteSocketAddress());
                DataInputStream disReader = new DataInputStream(clientEndpoint.getInputStream());
                DataOutputStream dosWriter = new DataOutputStream(clientEndpoint.getOutputStream());

                // Receive name from client
                String clientName = disReader.readUTF();
                System.out.println("Server: Client name received: " + clientName);

                // Start a loop to handle commands from the client
                while (true) {
                    // Receive command from client
                    String command = disReader.readUTF();
                    System.out.println("Server: Command received from " + clientName + ": " + command);

                    if (command.equals("/get")) {
                        // Fetch file path from client
                        String filePath = disReader.readUTF();
                        System.out.println("Server: File path received: " + filePath);
                        sendFile(dosWriter, filePath);
                    } else if (command.equalsIgnoreCase("exit")) {
                        // Exit the command loop if the client sends 'exit'
                        break;
                    } else {
                        System.out.println("Server: Unknown command.");
                    }
                }

                // Close connection
                clientEndpoint.close();
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private static void sendFile(DataOutputStream dosWriter, String filePath) throws IOException {
        File file = new File(filePath);
        System.out.println(filePath);

        if (file.exists() && file.isFile()) {
            // Send file name and size to the client
            dosWriter.writeUTF(file.getName());
            dosWriter.writeLong(file.length());

            System.out.println("Server: Sending file to client: " + file.getName() + " (" + file.length() + " bytes)");

            // Send file content
            byte[] buffer = new byte[4096];
            try (FileInputStream fis = new FileInputStream(file)) {
                int bytesRead;
                while ((bytesRead = fis.read(buffer)) != -1) {
                    dosWriter.write(buffer, 0, bytesRead);
                }
            }

            System.out.println("Server: File sent successfully");
        } else {
            System.out.println("Server: File not found or is not a regular file.");
            dosWriter.writeUTF("Server: File not found or is not a regular file.");
        }
    }
}
